<!DOCTYPE html>
<html class="page" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimal-ui" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="imagetoolbar" content="no" />
    <meta name="msthemecompatible" content="no" />
    <meta name="cleartype" content="on" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="format-detection" content="address=no" />
    <meta name="google" value="notranslate" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <!-- <link sizes="57x57" href="apple-touch-icon-57x57.png" rel="apple-touch-icon" />
    <link sizes="114x114" href="apple-touch-icon-114x114.png" rel="apple-touch-icon" />
    <link sizes="72x72" href="apple-touch-icon-72x72.png" rel="apple-touch-icon" />
    <link sizes="144x144" href="apple-touch-icon-144x144.png" rel="apple-touch-icon" />
    <link sizes="60x60" href="apple-touch-icon-60x60.png" rel="apple-touch-icon" />
    <link sizes="120x120" href="apple-touch-icon-120x120.png" rel="apple-touch-icon" />
    <link sizes="76x76" href="apple-touch-icon-76x76.png" rel="apple-touch-icon" />
    <link sizes="152x152" href="apple-touch-icon-152x152.png" rel="apple-touch-icon" />
    <link sizes="180x180" href="apple-touch-icon-180x180.png" rel="apple-touch-icon" />
    <link sizes="192x192" href="favicon-192x192.png" rel="icon" type="image/png" />
    <link sizes="160x160" href="favicon-160x160.png" rel="icon" type="image/png" />
    <link sizes="96x96" href="favicon-96x96.png" rel="icon" type="image/png" />
    <link sizes="16x16" href="favicon-16x16.png" rel="icon" type="image/png" />
    <link sizes="32x32" href="favicon-32x32.png" rel="icon" type="image/png" /> -->
    <meta name="application-name" content="Arcana Calculator" />
    <meta name="msapplication-tooltip" content="" />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta name="msapplication-TileImage" content="mstile-large.png" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="msapplication-square70x70logo" content="mstile-small.png" />
    <meta name="msapplication-square150x150logo" content="mstile-medium.png" />
    <meta name="msapplication-wide310x150logo" content="mstile-wide.png" />
    <meta name="msapplication-square310x310logo" content="mstile-large.png" />
    <title>Arcana Calculator</title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!--
        cardInfo.js must contain a single var `cardInfo` defined as an array of
        card objects. A card object looks like the following:
        {
            "id":5616,
            "name":"Wise Oracle",
            "element":"Passion",
            "rarity":"GLR",
            "baseAtk":44799,
            "baseDef":55999,
            "baseSol":51999,
            "maxAtk":70000,
            "maxDef":75600,
            "maxSol":68900,
            "maxLevel":110,
            "maxRarityAtk":150000,
            "maxRarityDef":150000,
            "maxRaritySol":150000,
            "perfectSoldierCount":83298,
            "rebirthCardId":7175,
            "isClosed":false
        }
        -->
    <script src="cardInfo.js"></script>

    <style type="text/css">
/* Style Sheets determine the look and feel of the page. */
label {
    display:block;
}

#inputs {
    max-width: 550px;
}

/* the has selector is only valid in CSS4 which no browsers actually support yet */
.field:has(input:disabled) {
    display:none;
}

.field:has(input:enabled) {
    display:initial;
}

.field {
    padding-bottom:15px;
    width: 100%;
}

.col {
    display:flex;
}
.col div.field {
    flex:auto;
}

#currentLevel, #maxLevel {
    width: 7ch;
}

#currentAtk, #currentDef, #currentSol {
    width: 10ch;
}

table {
  margin-top:20px;
  border-collapse: collapse;
}

table, th, td {
  border: 1px solid black;
  padding: 3px;
}

.footer {
    font-size: 0.8em;
}
    </style>

    <script type="text/javascript">
var selectedCard = null;
// this function is to initialize the form with card information
function init() {
    var cardSelect = document.forms["inputs"]["card"];
    // card info is loaded from the script tag in the header.
    if(typeof cardInfo === 'undefined' || !cardInfo.length){
        alert("Card info did not load properly");
        return false;
    }

    cardInfo.sort((a,b)=>{
        // sort on names first
        if(a.name < b.name) return -1;
        if(a.name > b.name) return 1;
        // names are equal, sort on rarity
        if(a.rarity < b.rarity) return -1;
        if(a.rarity > b.rarity) return 1;
        // name and rarity are the same
        return 0;
    });

    cardInfo.forEach(function(val,idx,arr){
        var option = document.createElement("option");
        option.value = val.id;
        option.text = val.name + " - " + val.rarity;
        cardSelect.add(option);
    });
};

// this function is to react to user selection changes of the card
function cardChange(select,form) {
    var cardId = select.value;
    var willRebirthCheck = form["rebirth"];
    var maxLvlElement = document.getElementById("rarityMaxLevel");
    if(!cardId || !(Number.isInteger(cardId) && cardId > 0)) {
        selectedCard = null;
        willRebirthCheck.disabled = true;
        willRebirthCheck.checked = false;
        maxLvlElement.textContent = "N/A";
    }
    // find the card in the cardInfo array
    const found = cardInfo.find(c => c.id == cardId);
    if(!found) {
        selectedCard = null;
        willRebirthCheck.disabled = true;
        willRebirthCheck.checked = false;
        maxLvlElement.textContent = "N/A";
        return;
    }
    selectedCard = found;
    if (selectedCard.rebirthCardId) {
        willRebirthCheck.disabled = false;
    } else {
        willRebirthCheck.disabled = true;
    }
    rebirthChange(willRebirthCheck, form);
};

function rebirthChange(checkbox, form) {
    if(!selectedCard) {
        maxLvlElement.textContent = "N/A";
        return;
    }

    var maxLvlElement = document.getElementById("rarityMaxLevel");
    var maxLevelInput = form["maxLevel"];
    var currentLevelInput = form["currentLevel"];
    var currentAtkInput = form["currentAtk"];
    var currentDefInput = form["currentDef"];
    var currentSolInput = form["currentSol"];

    var cardToUseForStats;

    if (!checkbox.disabled && checkbox.checked) {
        cardToUseForStats =
            cardInfo.find(c =>
                            c.id == selectedCard.rebirthCardId
                        ) || selectedCard;
    } else {
        cardToUseForStats = selectedCard;
    }

    
    maxLvlElement.textContent = cardToUseForStats.maxLevel;
    updateLevelLimits(currentLevelInput, maxLevelInput, cardToUseForStats)

    currentAtkInput.min = selectedCard.baseAtk;
    currentAtkInput.max = selectedCard.maxRarityAtk;
    
    currentDefInput.min = selectedCard.baseDef;
    currentDefInput.max = selectedCard.maxRarityDef;
    
    currentSolInput.min = selectedCard.baseSol;
    currentSolInput.max = selectedCard.maxRaritySol;
};

function updateLevelLimits(currentLevelInput, maxLevelInput, card) {
    currentLevelInput.max = Math.min(selectedCard.maxLevel, Number(maxLevelInput.value) || selectedCard.maxLevel);
    maxLevelInput.min = Math.max(Number(currentLevelInput.value) || 0, 1);
    maxLevelInput.max = card.maxLevel;
};

function levelChange(input, form) {
    var cardToUseForStats;
    var checkbox = form["rebirth"];
    if (!checkbox.disabled && checkbox.checked) {
        cardToUseForStats =
            cardInfo.find(c =>
                            c.id == selectedCard.rebirthCardId
                        ) || selectedCard;
    } else {
        cardToUseForStats = selectedCard;
    }

    updateLevelLimits(form["currentLevel"], form["maxLevel"], cardToUseForStats);
}

// this function reacts to any of the values changing in the form
function formChange(form) {
    // comment this if you want to have to hit the "Calculate" button
    calculateArcana(form);
};

function formValid(form) {
    // check if the form is set and has the checkValidity method
    if (!form || !form.checkValidity) return false;
    // actually check the validation
    return form.checkValidity();
};

function calculateArcana(form) {
    if (!formValid(form)) {
        return false;
    }
    // if our card info isn't initialized
    if(!cardInfo || !cardInfo.length){
        alert("Card info is not set. Must be a problem with the `init` method");
    }

    // result locations
    var atkMissing = document.getElementById("atkMissing");
    var atkTarget = document.getElementById("atkTarget");
    var atk50 = document.getElementById("atk50");
    var atk500 = document.getElementById("atk500");
    var atk3000 = document.getElementById("atk3000");

    var defMissing = document.getElementById("defMissing");
    var defTarget = document.getElementById("defTarget");
    var def50 = document.getElementById("def50");
    var def500 = document.getElementById("def500");
    var def3000 = document.getElementById("def3000");

    var soldiersMax = document.getElementById("soldiersMax");
    var soldiersPerfect = document.getElementById("soldiersPerfect");
    var soldiersDifference = document.getElementById("soldiersDifference");

    // values from the form
    var willRebirthCheck = form["rebirth"];
    var willRebirth = !willRebirthCheck.disabled && willRebirthCheck.checked;
    var maxLevel = Number(form["maxLevel"].value);
    var currentLevel = Number(form["currentLevel"].value);
    var levelGain = maxLevel - currentLevel;
    var currentAtk = Number(form["currentAtk"].value);
    var currentDef = Number(form["currentDef"].value);
    var currentSol = Number(form["currentSol"].value);

    // calculated values
    var atkMissingAtMaxLvl;
    var defMissingAtMaxLvl;
    var solAtMaxLvl;
    var solPerfectEvo;

    if (willRebirth) {
        var rebirthCard = cardInfo.find(c => c.id == selectedCard.rebirthCardId);

        var calcStat = function(current, base, max, rbBase, rbMax, rbMaxRarityStat){
            var statGainTotal = rbMax - rbBase;
            var statGainPerLevel = statGainTotal / (rebirthCard.maxLevel - 1);
            var statGainedByLevels = (maxLevel-1) * statGainPerLevel;
            var statRebirthBonus = rbBase - base - Math.round((currentLevel-1) * ((max - base) / (selectedCard.maxLevel - 1)));
            return Math.min(rbMaxRarityStat, current + statRebirthBonus + Math.round(statGainedByLevels));
        };

        atkMissingAtMaxLvl = rebirthCard.maxRarityAtk - calcStat(currentAtk,
                selectedCard.baseAtk, selectedCard.maxAtk,
                rebirthCard.baseAtk, rebirthCard.maxAtk, rebirthCard.maxRarityAtk
        );

        defMissingAtMaxLvl = rebirthCard.maxRarityDef - calcStat(currentDef,
                selectedCard.baseDef, selectedCard.maxDef,
                rebirthCard.baseDef, rebirthCard.maxDef, rebirthCard.maxRarityDef
        );
        
        if (currentSol) {
            solAtMaxLvl = calcStat(currentSol,
                    selectedCard.baseSol, selectedCard.maxSol,
                    rebirthCard.baseSol, rebirthCard.maxSol, rebirthCard.maxRaritySol
            );
        } else {
            solAtMaxLvl = "";
        }
        solPerfectEvo = rebirthCard.perfectSoldierCount;
    } else {
        atkMissingAtMaxLvl = selectedCard.maxRarityAtk - Math.min(selectedCard.maxRarityAtk, currentAtk + Math.round(levelGain * ((selectedCard.maxAtk - selectedCard.baseAtk) / (selectedCard.maxLevel - 1))));
        defMissingAtMaxLvl = selectedCard.maxRarityDef - Math.min(selectedCard.maxRarityDef, currentDef + Math.round(levelGain * ((selectedCard.maxDef - selectedCard.baseDef) / (selectedCard.maxLevel - 1))));
        if (currentSol) {
            solAtMaxLvl = Math.min(selectedCard.maxRaritySol, currentSol + Math.round(levelGain * ((selectedCard.maxSol - selectedCard.baseSol) / (selectedCard.maxLevel - 1))));
        } else {
            solAtMaxLvl = "";
        }
        solPerfectEvo = selectedCard.perfectSoldierCount;
    }
    
    atkMissing.textContent = atkMissingAtMaxLvl;
    atkTarget.textContent = atkMissingAtMaxLvl + currentAtk;
    atk50.textContent = Math.ceil(atkMissingAtMaxLvl / 50);
    atk500.textContent = Math.ceil(atkMissingAtMaxLvl / 500);
    atk3000.textContent = Math.ceil(atkMissingAtMaxLvl / 3000);

    defMissing.textContent = defMissingAtMaxLvl;
    defTarget.textContent = defMissingAtMaxLvl + currentDef;
    def50.textContent = Math.ceil(defMissingAtMaxLvl / 50);
    def500.textContent = Math.ceil(defMissingAtMaxLvl / 500);
    def3000.textContent = Math.ceil(defMissingAtMaxLvl / 3000);

    soldiersMax.textContent = solAtMaxLvl;
    soldiersPerfect.textContent = solPerfectEvo;
    soldiersDifference.textContent = solPerfectEvo - solAtMaxLvl;
};
    </script>
</head>
<body onload="init();">
    <noscript>This web page requires Javascript to be enabled.</noscript>
    <form id="inputs" onchange="formChange(this);" onsubmit="return false;" autocomplete="off">
        <div class="col">
            <div class="field">
                <label for="card">Card:</label>
                <select name="card" id="card" onchange="cardChange(this,this.form);" required="true" placeholder="">
                    <option value="">---Select a card---</option>
                    <!-- 
                        The rest of the options are added by javascript and loads the card info
                        defined in cardInfo.js
                    -->
                </select>
            </div>
            <div class="field">
                <label for="rebirth">Intending to rebirth:</label>
                <input type="checkbox" name="rebirth" id="rebirth" disabled="true" onchange="rebirthChange(this,this.form);" />
            </div>
        </div>
        <div class="col">
            <div class="field">
                <label for="currentLevel">Current Level:</label>
                <input type="number" min="1" max="130" name="currentLevel" id="currentLevel" value="1" required="true" onchange="levelChange(this,this.form);" />
            </div>
            <div class="field">
                <label for="maxLevel">Level you want to max stats:</label>
                <input type="number" min="1" max="130" name="maxLevel" id="maxLevel" required="true" onchange="levelChange(this,this.form);" /> out of <span id="rarityMaxLevel">N/A</span>
            </div>
        </div>
        <div class="col">
            <div class="field">
                <label for="currentAtk">Current Attack:</label>
                <input type="number" min="1" max="200000" name="currentAtk" id="currentAtk" required="true" />
            </div>
            <div class="field">
                <label for="currentDef">Current Defense:</label>
                <input type="number" min="1" max="200000" name="currentDef" id="currentDef" required="true" />
            </div>
        </div>
        <div class="field">
            <label for="currentSol">Current Soldiers (Optional):</label>
            <input type="number" min="1" max="200000" name="currentSol" id="currentSol"/>
        </div>
        <div style="clear:both;">
            <button type="reset">Reset</button>
            <button onclick="calculateArcana(this.form);">Calculate</button>
        </div>
    </form>
    <table id="results">
        <caption>Arcana Results</caption>
        <thead>
            <tr>
                <th>Stat:</th><th>Amt Needed</th><th>Target</th><th>+50 Arcana</th><th>+500 Arcana</th><th>+3k Arcana</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Attack</td><td id="atkMissing"></td><td id="atkTarget"></td><td id="atk50"></td><td id="atk500"></td><td id="atk3000"></td>
            </tr>
            <tr>
                <td>Defense</td><td id="defMissing"></td><td id=defTarget></td><td id="def50"></td><td id="def500"></td><td id="def3000"></td>
            </tr>
        </tbody>
    </table>
    <table id="soldierInfo">
        <caption>Soldier Info</caption>
        <thead>
            <tr>
                <th>Expected</th><th>Perfect Evo</th><th>Difference</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td id="soldiersMax">&nbsp;</td><td id="soldiersPerfect"></td><td id="soldiersDifference"></td>
            </tr>
        </tbody>
    </table>
    <div class="footer">
        <p>
            Have a problem? Bad calculation, missing card, want more information on display?
            Please fill out an <a href="https://github.com/kushieda-minori/vc-arcana-calc/issues/new/choose">issue</a>.
        </p>
        <p>
            Want to help me keep the card list up to date, or have a feature/fix you want to try yourself?
            <a href="https://github.com/kushieda-minori/vc-arcana-calc">Fork</a> this page and work on it yourself.
            Create a pull request when done.
        </p>
    </div>
</body>
</html>
